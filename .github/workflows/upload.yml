name: Artbox Image Upload

on:
  workflow_dispatch:
  repository_dispatch:
    types: [upload_image]

jobs:
  upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Decode image and save
        env:
          IMG_DATA: ${{ github.event.client_payload.image_base64 }}
          IMG_NAME: ${{ github.event.client_payload.image_name }}
          IMG_DESC: ${{ github.event.client_payload.image_desc }}
        run: |
          echo "$IMG_DATA" | base64 --decode > "$IMG_NAME"
          echo "$IMG_DESC" > "${IMG_NAME}.txt"

      - name: Commit and push new image
        env:
          GH_TOKEN: ${{ secrets.TOKEN_UPLOAD }}
        run: |
          git config user.name "Artbox Bot"
          git config user.email "bot@artbox.local"
          git add .
          git commit -m "Add ${{ github.event.client_payload.image_name }} via web upload"
          git push https://x-access-token:${GH_TOKEN}@github.com/artboxmb/artboxmb.git HEAD:main
